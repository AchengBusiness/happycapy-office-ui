<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Capy åˆ›ä¸šå°çª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Microsoft YaHei', sans-serif;
            overflow: hidden;
        }

        .main-container {
            position: relative;
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        /* çš®è‚¤é€‰æ‹©é¢æ¿ */
        .skin-panel {
            position: fixed;
            left: 20px;
            top: 20px;
            background: rgba(30, 25, 35, 0.95);
            border-radius: 12px;
            padding: 15px;
            border: 2px solid #d4a44a;
            z-index: 100;
        }

        .skin-panel h3 {
            color: #d4a44a;
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .skin-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .skin-btn {
            padding: 6px 12px;
            background: #2a2530;
            border: 1px solid #555;
            border-radius: 6px;
            color: #ccc;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .skin-btn:hover {
            background: #3a3540;
            border-color: #d4a44a;
        }

        .skin-btn.active {
            background: #d4a44a;
            color: #1a1520;
            border-color: #d4a44a;
        }

        /* ç»Ÿè®¡é¢æ¿ */
        .stats-panel {
            position: fixed;
            right: 20px;
            top: 20px;
            background: rgba(30, 25, 35, 0.95);
            border-radius: 12px;
            padding: 15px;
            border: 2px solid #d4a44a;
            min-width: 160px;
            z-index: 100;
        }

        .stats-panel h3 {
            color: #d4a44a;
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            color: #aaa;
            font-size: 12px;
            margin-bottom: 6px;
        }

        .stat-value {
            color: #4ecdc4;
            font-weight: bold;
        }

        /* æ¸¸æˆå®¹å™¨ */
        .game-wrapper {
            position: relative;
            border: 3px solid #d4a44a;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }

        .office-bg {
            display: block;
            width: 900px;
            height: auto;
        }

        /* äº¤äº’åŒºåŸŸ */
        .area-overlay {
            position: absolute;
            border: 3px dashed transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .area-overlay:hover {
            border-color: #f1c40f;
            background: rgba(241, 196, 15, 0.15);
        }

        .area-overlay.active {
            border-color: #2ecc71;
            background: rgba(46, 204, 113, 0.2);
        }

        .area-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .area-overlay:hover .area-label {
            opacity: 1;
        }

        /* Logo å¾½ç«  - è¦†ç›–ç‘•ç–µ */
        .logo-badge {
            position: absolute;
            right: 3%;
            bottom: 4%;
            width: 42px;
            height: 42px;
            background: rgba(20, 15, 25, 0.95);
            border: 2px solid #d4a44a;
            border-radius: 6px;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: #d4a44a;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            cursor: default;
        }

        /* æ°´è±šç²¾çµ */
        .capybara {
            position: absolute;
            width: 60px;
            height: 60px;
            z-index: 50;
            image-rendering: auto;
        }

        /* å¯ç”¨è¿‡æ¸¡åŠ¨ç”»ï¼ˆåˆå§‹åŒ–åæ·»åŠ ï¼‰ */
        .capybara.enable-transition {
            transition: left 3s ease-in-out,
                        top 3s ease-in-out;
        }

        /* ç§»åŠ¨ä¸­çš„èµ°è·¯åŠ¨ç”» - ç¼“æ…¢æ‚ é—²çš„å°ç¢æ­¥ */
        .capybara.walking {
            animation: walk 0.5s ease-in-out infinite;
        }

        @keyframes walk {
            0%, 100% { transform: translateY(0) scaleX(1); }
            25% { transform: translateY(-3px) scaleX(0.98); }
            50% { transform: translateY(0) scaleX(1); }
            75% { transform: translateY(-3px) scaleX(1.02); }
        }

        .capybara img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* æ°”æ³¡ */
        .speech-bubble {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 12px;
            color: #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 60;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s;
            pointer-events: none;
            max-width: 150px;
        }

        .speech-bubble.show {
            opacity: 1;
            transform: translateY(0);
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 20px;
            border: 8px solid transparent;
            border-top-color: rgba(255, 255, 255, 0.95);
            border-bottom: none;
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 25, 35, 0.95);
            border: 2px solid #d4a44a;
            border-radius: 25px;
            padding: 12px 30px;
            color: #fff;
            font-size: 14px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-idle { background: #3498db; }
        .status-working { background: #2ecc71; }
        .status-thinking { background: #f1c40f; }
        .status-error { background: #e74c3c; }

        .demo-btn {
            margin-left: 15px;
            padding: 6px 12px;
            background: #9b59b6;
            border: none;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .demo-btn:hover {
            background: #8e44ad;
        }

        .demo-btn.active {
            background: #e74c3c;
            animation: pulse 1s infinite;
        }

        /* è¿›åº¦æ¡ */
        .progress-bar {
            position: absolute;
            height: 6px;
            background: rgba(0,0,0,0.5);
            border-radius: 3px;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .progress-bar.show {
            opacity: 1;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f1c40f, #e67e22);
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* åŠ è½½æç¤º */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #d4a44a;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- çš®è‚¤é€‰æ‹© -->
    <div class="skin-panel">
        <h3><span>ğŸ¦«</span> Capyè£…æ‰®</h3>
        <div class="skin-buttons">
            <button class="skin-btn active" data-skin="default">é»˜è®¤</button>
            <button class="skin-btn" data-skin="glasses">çœ¼é•œ</button>
            <button class="skin-btn" data-skin="hat">å¸½å­</button>
            <button class="skin-btn" data-skin="bowtie">é¢†ç»“</button>
            <button class="skin-btn" data-skin="crown">çš‡å† </button>
        </div>
    </div>

    <!-- ç»Ÿè®¡é¢æ¿ -->
    <div class="stats-panel">
        <h3><span>ğŸ“Š</span> å·¥ä½œç»Ÿè®¡</h3>
        <div class="stat-item">
            <span>åŠå…¬æ¡Œ</span>
            <span class="stat-value" id="stat-desk">0åˆ†é’Ÿ</span>
        </div>
        <div class="stat-item">
            <span>å›¾ä¹¦åŒº</span>
            <span class="stat-value" id="stat-library">0åˆ†é’Ÿ</span>
        </div>
        <div class="stat-item">
            <span>æœåŠ¡å™¨</span>
            <span class="stat-value" id="stat-server">0åˆ†é’Ÿ</span>
        </div>
        <div class="stat-item">
            <span>ä¼‘æ¯åŒº</span>
            <span class="stat-value" id="stat-lounge">0åˆ†é’Ÿ</span>
        </div>
        <div class="stat-item">
            <span>ä¼šè®®å®¤</span>
            <span class="stat-value" id="stat-meeting">0åˆ†é’Ÿ</span>
        </div>
        <div class="stat-item" style="border-top: 1px solid #444; padding-top: 6px; margin-top: 6px;">
            <span>ä»Šæ—¥æ€»è®¡</span>
            <span class="stat-value" id="stat-total">0åˆ†é’Ÿ</span>
        </div>
    </div>

    <!-- æ¸¸æˆåŒºåŸŸ -->
    <div class="game-wrapper">
        <img src="" alt="Office" class="office-bg" id="officeBg">
        <div class="loading" id="loading">åŠ è½½ä¸­...</div>

        <!-- äº¤äº’åŒºåŸŸå°†ç”±JSåŠ¨æ€åˆ›å»º -->
        <div id="areas-container"></div>

        <!-- Logo å¾½ç«  -->
        <div class="logo-badge" title="HappyCapy">HC</div>

        <!-- æ°´è±š -->
        <div class="capybara" id="capybara">
            <img src="" alt="Capy" id="capyImg">
        </div>

        <!-- æ°”æ³¡ -->
        <div class="speech-bubble" id="bubble"></div>

        <!-- è¿›åº¦æ¡ -->
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <!-- çŠ¶æ€æ  -->
    <div class="status-bar">
        <div class="status-indicator status-idle" id="statusIndicator"></div>
        <span id="statusText">[å¾…å‘½] ç­‰å¾…ä»»åŠ¡ä¸­...</span>
        <button class="demo-btn" id="demoBtn" onclick="toggleDemo()">æ¼”ç¤ºæ¨¡å¼</button>
    </div>

    <script src="/static/bg_base64.js?v=11"></script>
    <script>
        // åŒºåŸŸé…ç½® - æ ¹æ®å›¾ç‰‡1200x896ç²¾ç¡®å®šä½
        const AREAS = {
            desk: {
                name: 'åŠå…¬æ¡Œ',
                // å·¦ä¸Šè§’åŠå…¬æ¡ŒåŒºåŸŸ - çº¢åœ°æ¯¯+ç”µè„‘æ¡Œ
                x: 40, y: 128, width: 320, height: 240,
                // Capyååœ¨ç”µè„‘æ¤…å­ä¸Š
                capyPos: { x: 200, y: 280 }
            },
            meeting: {
                name: 'ä¼šè®®å®¤',
                // ä¸­é—´ä¼šè®®æ¡ŒåŒºåŸŸ - è“åœ°æ¯¯+åœ†æ¡Œ
                x: 340, y: 280, width: 520, height: 300,
                // Capyååœ¨ä¼šè®®æ¡Œæ—çš„æ¤…å­ä¸Š
                capyPos: { x: 600, y: 450 }
            },
            server: {
                name: 'æœåŠ¡å™¨æœºæˆ¿',
                // å³ä¸Šè§’æœåŠ¡å™¨åŒºåŸŸ
                x: 840, y: 128, width: 320, height: 240,
                // Capyç«™åœ¨æœåŠ¡å™¨æœºæŸœå‰
                capyPos: { x: 980, y: 280 }
            },
            lounge: {
                name: 'ä¼‘æ¯åŒº',
                // å·¦ä¸‹è§’æ²™å‘åŒºåŸŸ - ç»¿æ²™å‘
                x: 40, y: 430, width: 320, height: 300,
                // Capyååœ¨ç»¿æ²™å‘çš„åå«ä¸Š (å…³é”®ä¿®å¤ï¼šyå€¼è°ƒæ•´åˆ°æ²™å‘åå«ä½ç½®)
                capyPos: { x: 180, y: 680 }
            },
            library: {
                name: 'å›¾ä¹¦åŒº',
                // å³ä¸‹è§’ä¹¦æ¶åŒºåŸŸ
                x: 840, y: 430, width: 320, height: 300,
                // Capyç«™åœ¨ä¹¦æ¶æ—è¾¹çš„åœ°æ¿ä¸Šçœ‹ä¹¦ (ä¸æ˜¯ç«™åœ¨ä¹¦ä¸Š)
                capyPos: { x: 920, y: 680 }
            }
        };

        // çŠ¶æ€æ˜ å°„ - æ›´ç»†åˆ†çš„çŠ¶æ€
        const STATE_CONFIG = {
            // å¾…æœºçŠ¶æ€
            idle: { area: 'lounge', color: '#3498db', label: 'å¾…å‘½' },
            waiting: { area: 'lounge', color: '#3498db', label: 'ç­‰å¾…ä¸­' },
            ready: { area: 'lounge', color: '#2ecc71', label: 'å‡†å¤‡å°±ç»ª' },

            // æ€è€ƒç±»çŠ¶æ€
            thinking: { area: 'library', color: '#f1c40f', label: 'æ€è€ƒä¸­' },
            analyzing: { area: 'library', color: '#f39c12', label: 'åˆ†æä¸­' },
            planning: { area: 'library', color: '#e74c3c', label: 'è§„åˆ’ä¸­' },

            // ç ”ç©¶ç±»çŠ¶æ€
            researching: { area: 'library', color: '#9b59b6', label: 'æŸ¥èµ„æ–™' },
            reading: { area: 'library', color: '#8e44ad', label: 'é˜…è¯»ä¸­' },
            learning: { area: 'library', color: '#9b59b6', label: 'å­¦ä¹ ä¸­' },
            searching: { area: 'library', color: '#3498db', label: 'æœç´¢ä¸­' },

            // ç¼–ç ç±»çŠ¶æ€
            writing: { area: 'desk', color: '#2ecc71', label: 'ç¼–ç ä¸­' },
            coding: { area: 'desk', color: '#27ae60', label: 'å†™ä»£ç ' },
            editing: { area: 'desk', color: '#1abc9c', label: 'ç¼–è¾‘ä¸­' },
            debugging: { area: 'desk', color: '#e67e22', label: 'è°ƒè¯•ä¸­' },
            refactoring: { area: 'desk', color: '#16a085', label: 'é‡æ„ä¸­' },

            // æ‰§è¡Œç±»çŠ¶æ€
            executing: { area: 'server', color: '#e67e22', label: 'æ‰§è¡Œä¸­' },
            running: { area: 'server', color: '#d35400', label: 'è¿è¡Œä¸­' },
            processing: { area: 'server', color: '#e74c3c', label: 'å¤„ç†ä¸­' },
            building: { area: 'server', color: '#f39c12', label: 'æ„å»ºä¸­' },
            testing: { area: 'server', color: '#9b59b6', label: 'æµ‹è¯•ä¸­' },
            deploying: { area: 'server', color: '#1abc9c', label: 'éƒ¨ç½²ä¸­' },

            // åä½œç±»çŠ¶æ€ï¼ˆä¼šè®®å®¤ï¼‰
            meeting: { area: 'meeting', color: '#1abc9c', label: 'å¼€ä¼šä¸­' },
            discussing: { area: 'meeting', color: '#16a085', label: 'è®¨è®ºä¸­' },
            reviewing: { area: 'meeting', color: '#2980b9', label: 'è¯„å®¡ä¸­' },
            collaborating: { area: 'meeting', color: '#8e44ad', label: 'åä½œä¸­' },
            responding: { area: 'meeting', color: '#3498db', label: 'å›å¤ä¸­' },
            explaining: { area: 'meeting', color: '#9b59b6', label: 'è§£é‡Šä¸­' },
            presenting: { area: 'meeting', color: '#e67e22', label: 'å±•ç¤ºä¸­' },
            chatting: { area: 'meeting', color: '#1abc9c', label: 'é—²èŠä¸­' },
            answering: { area: 'meeting', color: '#27ae60', label: 'å›ç­”ä¸­' },

            // å¼‚å¸¸çŠ¶æ€
            error: { area: 'lounge', color: '#e74c3c', label: 'å‡ºé”™äº†' },
            stuck: { area: 'lounge', color: '#c0392b', label: 'å¡ä½äº†' },
            confused: { area: 'library', color: '#e74c3c', label: 'å›°æƒ‘ä¸­' }
        };

        // æ°”æ³¡æ–‡å­— - å¹½é»˜å†…å¿ƒOS
        const BUBBLE_TEXTS = {
            idle: [
                'æ‘¸é±¼æ—¶é—´åˆ°~',
                'è€æ¿ä¸åœ¨ï¼Œæ”¾æ¾ä¸€ä¸‹',
                'ä»Šå¤©ä¹Ÿæ˜¯åŠªåŠ›èººå¹³çš„ä¸€å¤©',
                'é”®ç›˜æ•²ç´¯äº†ï¼Œä¼‘æ¯5åˆ†é’Ÿ',
                'æ³¡æ¯å’–å•¡å…ˆ...',
                'Capyéœ€è¦å……ç”µ',
                'å‘å‘†ä¹Ÿæ˜¯ä¸€ç§å·¥ä½œ',
                'ç­‰ç­‰...åˆšæ‰æƒ³åˆ°å“ªäº†ï¼Ÿ',
                'æ‰“ä¸ªç›¹ä¸è¿‡åˆ†å§ï¼Ÿ',
                'å·¥ä½œï¼Ÿä»€ä¹ˆå·¥ä½œï¼Ÿ'
            ],
            waiting: [
                'ç­‰ä½ å‘¢ï¼Œå¿«ç‚¹~',
                'æ— èŠ.jpg',
                'æœ‰æ´»æ¥äº†å—ï¼Ÿ',
                'éšæ—¶å¾…å‘½ä¸­...'
            ],
            thinking: [
                'è®©æˆ‘æƒ³æƒ³...',
                'å—¯...è¿™ä¸ªå˜›...',
                'å¤§è„‘æ­£åœ¨é«˜é€Ÿè¿è½¬',
                'æ€è€ƒäººç”Ÿ.jpg',
                'æ®æˆ‘åˆ†æ...',
                'ç­‰ç­‰ï¼Œçµæ„Ÿæ¥äº†ï¼',
                'è¿™é¢˜æˆ‘è§è¿‡ï¼',
                'å®¹æˆ‘ä¸‰æ€...',
                'è„‘å­ï¼šå·²è¿‡è½½',
                'å“²å­¦æ€§æ€è€ƒä¸­...'
            ],
            analyzing: [
                'åˆ†æä¸­ï¼Œå‹¿æ‰°',
                'æ•°æ®å¥½å¤šå•Š...',
                'è®©æˆ‘åº·åº·...',
                'ç¦å°”æ‘©æ–¯æ¨¡å¼å¼€å¯'
            ],
            researching: [
                'æŸ¥èµ„æ–™ä¸­...åˆ«å‚¬',
                'Googleæ˜¯æˆ‘æœ‹å‹',
                'Stack Overflowæ•‘æˆ‘',
                'çŸ¥è¯†å°±æ˜¯åŠ›é‡ï¼',
                'åˆå­¦åˆ°æ–°ä¸œè¥¿äº†',
                'è¿™æ–‡æ¡£å†™çš„ä»€ä¹ˆé¬¼...',
                'ç»ˆäºæ‰¾åˆ°äº†ï¼',
                'RTFM ing...'
            ],
            reading: [
                'è®¤çœŸé˜…è¯»ä¸­...',
                'è¿™æ®µä»£ç æœ‰æ„æ€',
                'çœ‹ä¸æ‡‚ï¼Œè£…æ‡‚ä¸­',
                'å­—éƒ½è®¤è¯†ï¼Œè¿èµ·æ¥å°±...'
            ],
            writing: [
                'æ•²ä»£ç ä¸­ï¼Œè¯·å‹¿æ‰“æ‰°',
                'é”®ç›˜åœ¨ç‡ƒçƒ§ï¼',
                'Bugåˆ¶é€ æœºå¯åŠ¨~',
                'å†™å®Œå°±ä¸‹ç­ï¼',
                'è¿™ä»£ç ç»äº†',
                'ä¼˜é›…ï¼å¤ªä¼˜é›…äº†ï¼',
                'cvå¤§æ³•å¥½',
                'ä¸€é¡¿æ“ä½œçŒ›å¦‚è™',
                'å¤´å‘åˆå°‘äº†...',
                'è¿™æ ·å†™åº”è¯¥æ²¡é—®é¢˜å§ï¼Ÿ'
            ],
            coding: [
                'ä»£ç å¦‚è¯—~',
                '// TODO: ä»¥åå†è¯´',
                'console.logè°ƒè¯•å¤§æ³•',
                'èƒ½è·‘å°±è¡Œ.jpg'
            ],
            debugging: [
                'è¿™Bugä»å“ªæ¥çš„ï¼Ÿ',
                'ä¸æ˜¯æˆ‘å†™çš„ï¼',
                '99ä¸ªBugï¼Œä¿®1ä¸ª...',
                'è¿˜å‰©100ä¸ªBug',
                'è¦ç–¯äº†...',
                'æ˜æ˜åˆšæ‰è¿˜å¥½å¥½çš„ï¼',
                'ä¸ºä»€ä¹ˆä¸è¡Œï¼Ÿï¼Ÿï¼Ÿ'
            ],
            executing: [
                'è¿è¡Œä¸­...ç¥ˆç¥·å§',
                'æœåŠ¡å™¨åˆ«ç‚¸...',
                'èƒ½è¿‡å°±æ˜¯èƒœåˆ©',
                'è¿›åº¦æ¡å¥½æ…¢å•Š',
                'Loading...',
                'ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨å€™'
            ],
            running: [
                'è·‘èµ·æ¥äº†ï¼',
                'è¿˜åœ¨è·‘...',
                'å¿«äº†å¿«äº†...',
                'æœåŠ¡å™¨ï¼šæˆ‘å¤ªéš¾äº†'
            ],
            testing: [
                'æµ‹è¯•ä¸­ï¼Œå¿ƒæƒŠèƒ†æˆ˜',
                'ç»¿äº†ç»¿äº†ï¼',
                'æ€ä¹ˆçº¢äº†ï¼Ÿï¼',
                'å•å…ƒæµ‹è¯•ï¼Ÿä¸å­˜åœ¨çš„'
            ],
            meeting: [
                'å¼€ä¼šing...',
                'åˆå¼€ä¼šï¼Ÿ',
                'è¿™ä¼šèƒ½çŸ­ç‚¹å—',
                'ç¥æ¸¸ä¸­...',
                'å‡è£…åœ¨å¬.jpg',
                'ç‚¹å¤´å°±å®Œäº‹äº†',
                'å¥½çš„å¥½çš„ï¼Œæ²¡é—®é¢˜'
            ],
            discussing: [
                'æ¿€çƒˆè®¨è®ºä¸­',
                'æˆ‘è§‰å¾—å¯ä»¥...',
                'ä½ è¯´å¾—å¯¹ï¼Œä½†æ˜¯...',
                'å¤´è„‘é£æš´ï¼'
            ],
            responding: [
                'è®©æˆ‘æ¥å›ç­”~',
                'å¥½é—®é¢˜ï¼',
                'ç¨ç­‰ï¼Œæ•´ç†ä¸€ä¸‹æ€è·¯',
                'è¿™ä¸ªæˆ‘çŸ¥é“ï¼'
            ],
            explaining: [
                'å¬æˆ‘ç»™ä½ è®²...',
                'ç®€å•æ¥è¯´å°±æ˜¯...',
                'ä¸¾ä¸ªä¾‹å­å§',
                'ä½ æ‡‚æˆ‘æ„æ€å—ï¼Ÿ'
            ],
            presenting: [
                'çœ‹è¿™é‡Œï¼',
                'é‡ç‚¹æ¥äº†',
                'æˆæœå±•ç¤ºæ—¶é—´',
                'Ta-da~'
            ],
            chatting: [
                'é—²èŠä¸€ä¸‹~',
                'è¯è¯´...',
                'å¯¹äº†å¯¹äº†',
                'å“ˆå“ˆå“ˆ'
            ],
            answering: [
                'ç­”æ¡ˆæ˜¯...',
                'æˆ‘æ¥è§£ç­”',
                'è¿™æ ·çš„...',
                'ä½ é—®å¯¹äººäº†ï¼'
            ],
            error: [
                'å•Šè¿™...å‡ºé”™äº†',
                'æ•‘å‘½ï¼',
                'ä¸æ˜¯æˆ‘çš„é”…ï¼',
                'åˆ«æ…Œï¼Œè®©æˆ‘çœ‹çœ‹',
                'é‡å¯è¯•è¯•ï¼Ÿ',
                'å®Œè›‹.jpg',
                'è°åŠ¨æˆ‘ä»£ç äº†ï¼Ÿ'
            ],
            stuck: [
                'å¡ä½äº†...',
                'æ•‘æ•‘å­©å­',
                'è„‘å­ç©ºç™½ä¸­',
                'éœ€è¦å¸®åŠ©ï¼'
            ],
            confused: [
                '???',
                'çœ‹ä¸æ‡‚...',
                'è¿™ä»€ä¹ˆé¬¼ï¼Ÿ',
                'æˆ‘æ˜¯è°ï¼Ÿæˆ‘åœ¨å“ªï¼Ÿ'
            ]
        };

        // çŠ¶æ€
        let currentState = 'idle';
        let currentSkin = 'default';
        let currentArea = 'lounge';
        let stats = { desk: 0, library: 0, server: 0, lounge: 0, meeting: 0 };
        let lastUpdate = Date.now();
        let walkingTimeout = null; // èµ°è·¯åŠ¨ç”»å®šæ—¶å™¨

        // æ°´è±šå›¾ç‰‡ (ä½¿ç”¨emojiä½œä¸ºå ä½ç¬¦ï¼Œä¹‹åå¯ä»¥æ›¿æ¢ä¸ºçœŸå®å›¾ç‰‡)
        const capyImages = {
            default: 'data:image/svg+xml,' + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                    <ellipse cx="50" cy="60" rx="35" ry="25" fill="#8B6914"/>
                    <ellipse cx="50" cy="40" rx="28" ry="22" fill="#A0782C"/>
                    <ellipse cx="35" cy="15" rx="8" ry="10" fill="#8B6914"/>
                    <ellipse cx="65" cy="15" rx="8" ry="10" fill="#8B6914"/>
                    <ellipse cx="50" cy="48" rx="12" ry="8" fill="#5D4E37"/>
                    <circle cx="40" cy="35" r="4" fill="#2C2416"/>
                    <circle cx="60" cy="35" r="4" fill="#2C2416"/>
                    <circle cx="41" cy="34" r="1.5" fill="white"/>
                    <circle cx="61" cy="34" r="1.5" fill="white"/>
                    <ellipse cx="35" cy="75" rx="10" ry="8" fill="#7A5D12"/>
                    <ellipse cx="65" cy="75" rx="10" ry="8" fill="#7A5D12"/>
                </svg>
            `),
            glasses: 'data:image/svg+xml,' + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                    <ellipse cx="50" cy="60" rx="35" ry="25" fill="#8B6914"/>
                    <ellipse cx="50" cy="40" rx="28" ry="22" fill="#A0782C"/>
                    <ellipse cx="35" cy="15" rx="8" ry="10" fill="#8B6914"/>
                    <ellipse cx="65" cy="15" rx="8" ry="10" fill="#8B6914"/>
                    <ellipse cx="50" cy="48" rx="12" ry="8" fill="#5D4E37"/>
                    <circle cx="40" cy="35" r="4" fill="#2C2416"/>
                    <circle cx="60" cy="35" r="4" fill="#2C2416"/>
                    <circle cx="41" cy="34" r="1.5" fill="white"/>
                    <circle cx="61" cy="34" r="1.5" fill="white"/>
                    <ellipse cx="35" cy="75" rx="10" ry="8" fill="#7A5D12"/>
                    <ellipse cx="65" cy="75" rx="10" ry="8" fill="#7A5D12"/>
                    <rect x="30" y="30" width="15" height="12" rx="2" fill="none" stroke="#333" stroke-width="2"/>
                    <rect x="55" y="30" width="15" height="12" rx="2" fill="none" stroke="#333" stroke-width="2"/>
                    <line x1="45" y1="36" x2="55" y2="36" stroke="#333" stroke-width="2"/>
                </svg>
            `),
            hat: 'data:image/svg+xml,' + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                    <ellipse cx="50" cy="65" rx="35" ry="25" fill="#8B6914"/>
                    <ellipse cx="50" cy="45" rx="28" ry="22" fill="#A0782C"/>
                    <ellipse cx="35" cy="22" rx="8" ry="10" fill="#8B6914"/>
                    <ellipse cx="65" cy="22" rx="8" ry="10" fill="#8B6914"/>
                    <ellipse cx="50" cy="53" rx="12" ry="8" fill="#5D4E37"/>
                    <circle cx="40" cy="40" r="4" fill="#2C2416"/>
                    <circle cx="60" cy="40" r="4" fill="#2C2416"/>
                    <circle cx="41" cy="39" r="1.5" fill="white"/>
                    <circle cx="61" cy="39" r="1.5" fill="white"/>
                    <ellipse cx="35" cy="80" rx="10" ry="8" fill="#7A5D12"/>
                    <ellipse cx="65" cy="80" rx="10" ry="8" fill="#7A5D12"/>
                    <rect x="30" y="8" width="40" height="15" fill="#3498db"/>
                    <rect x="25" y="20" width="50" height="6" fill="#3498db"/>
                </svg>
            `),
            bowtie: 'data:image/svg+xml,' + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                    <ellipse cx="50" cy="55" rx="35" ry="25" fill="#8B6914"/>
                    <ellipse cx="50" cy="35" rx="28" ry="22" fill="#A0782C"/>
                    <ellipse cx="35" cy="12" rx="8" ry="10" fill="#8B6914"/>
                    <ellipse cx="65" cy="12" rx="8" ry="10" fill="#8B6914"/>
                    <ellipse cx="50" cy="43" rx="12" ry="8" fill="#5D4E37"/>
                    <circle cx="40" cy="30" r="4" fill="#2C2416"/>
                    <circle cx="60" cy="30" r="4" fill="#2C2416"/>
                    <circle cx="41" cy="29" r="1.5" fill="white"/>
                    <circle cx="61" cy="29" r="1.5" fill="white"/>
                    <ellipse cx="35" cy="70" rx="10" ry="8" fill="#7A5D12"/>
                    <ellipse cx="65" cy="70" rx="10" ry="8" fill="#7A5D12"/>
                    <polygon points="35,58 50,65 35,72" fill="#e74c3c"/>
                    <polygon points="65,58 50,65 65,72" fill="#e74c3c"/>
                    <circle cx="50" cy="65" r="4" fill="#c0392b"/>
                </svg>
            `),
            crown: 'data:image/svg+xml,' + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                    <ellipse cx="50" cy="65" rx="35" ry="25" fill="#8B6914"/>
                    <ellipse cx="50" cy="45" rx="28" ry="22" fill="#A0782C"/>
                    <ellipse cx="35" cy="22" rx="8" ry="10" fill="#8B6914"/>
                    <ellipse cx="65" cy="22" rx="8" ry="10" fill="#8B6914"/>
                    <ellipse cx="50" cy="53" rx="12" ry="8" fill="#5D4E37"/>
                    <circle cx="40" cy="40" r="4" fill="#2C2416"/>
                    <circle cx="60" cy="40" r="4" fill="#2C2416"/>
                    <circle cx="41" cy="39" r="1.5" fill="white"/>
                    <circle cx="61" cy="39" r="1.5" fill="white"/>
                    <ellipse cx="35" cy="80" rx="10" ry="8" fill="#7A5D12"/>
                    <ellipse cx="65" cy="80" rx="10" ry="8" fill="#7A5D12"/>
                    <polygon points="30,18 35,5 42,15 50,2 58,15 65,5 70,18" fill="#f1c40f"/>
                    <rect x="30" y="18" width="40" height="6" fill="#f1c40f"/>
                    <circle cx="50" cy="8" r="3" fill="#e74c3c"/>
                </svg>
            `)
        };

        // åˆå§‹åŒ–
        function init() {
            const img = document.getElementById('officeBg');

            // ä½¿ç”¨base64ç¼–ç çš„å›¾ç‰‡
            img.src = OFFICE_BG;

            img.onload = function() {
                document.getElementById('loading').style.display = 'none';
                createAreas();
                updateCapy();

                // åŠ è½½æŒä¹…åŒ–çš„ç»Ÿè®¡æ•°æ®
                loadStats();
                updateStatsDisplay();

                // åˆå§‹ä½ç½®ï¼šæ— åŠ¨ç”»ï¼Œç›´æ¥å®šä½
                setCapyPositionInstant('lounge');

                // å»¶è¿Ÿå¯ç”¨è¿‡æ¸¡åŠ¨ç”»ï¼Œé¿å…åˆå§‹åŠ è½½å¡é¡¿
                setTimeout(() => {
                    document.getElementById('capybara').classList.add('enable-transition');
                }, 100);

                startPolling();
                startBubbleTimer();
            };

            img.onerror = function() {
                document.getElementById('loading').textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
            };

            // çš®è‚¤æŒ‰é’®
            document.querySelectorAll('.skin-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.skin-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentSkin = btn.dataset.skin;
                    updateCapy();
                });
            });
        }

        // åˆ›å»ºäº¤äº’åŒºåŸŸ
        function createAreas() {
            const container = document.getElementById('areas-container');
            const img = document.getElementById('officeBg');
            const scale = img.offsetWidth / img.naturalWidth;

            Object.entries(AREAS).forEach(([key, area]) => {
                const div = document.createElement('div');
                div.className = 'area-overlay';
                div.id = `area-${key}`;
                div.style.left = (area.x * scale) + 'px';
                div.style.top = (area.y * scale) + 'px';
                div.style.width = (area.width * scale) + 'px';
                div.style.height = (area.height * scale) + 'px';

                const label = document.createElement('div');
                label.className = 'area-label';
                label.textContent = area.name;
                div.appendChild(label);

                div.addEventListener('click', () => moveCapyToArea(key));

                container.appendChild(div);
            });
        }

        // è®¾ç½®æ°´è±šä½ç½®ï¼ˆæ— åŠ¨ç”»ï¼Œç”¨äºåˆå§‹åŒ–ï¼‰
        function setCapyPositionInstant(areaKey) {
            const img = document.getElementById('officeBg');
            const scale = img.offsetWidth / img.naturalWidth;
            const area = AREAS[areaKey];
            const capy = document.getElementById('capybara');

            // ç›´æ¥è®¾ç½®ä½ç½®
            capy.style.left = (area.capyPos.x * scale - 30) + 'px';
            capy.style.top = (area.capyPos.y * scale - 30) + 'px';

            // æ›´æ–°æ´»åŠ¨åŒºåŸŸé«˜äº®
            document.querySelectorAll('.area-overlay').forEach(el => el.classList.remove('active'));
            document.getElementById(`area-${areaKey}`).classList.add('active');

            currentArea = areaKey;
        }

        // ç§»åŠ¨æ°´è±šåˆ°æŒ‡å®šåŒºåŸŸï¼ˆå¸¦èµ°è·¯åŠ¨ç”»ï¼‰
        function moveCapyToArea(areaKey) {
            const img = document.getElementById('officeBg');
            const scale = img.offsetWidth / img.naturalWidth;
            const area = AREAS[areaKey];
            const capy = document.getElementById('capybara');

            // æ›´æ–°æ´»åŠ¨åŒºåŸŸé«˜äº®
            document.querySelectorAll('.area-overlay').forEach(el => el.classList.remove('active'));
            document.getElementById(`area-${areaKey}`).classList.add('active');

            const newLeft = area.capyPos.x * scale - 30;
            const newTop = area.capyPos.y * scale - 30;

            // è®¡ç®—ç§»åŠ¨è·ç¦»
            const currentLeft = parseFloat(capy.style.left) || 0;
            const currentTop = parseFloat(capy.style.top) || 0;
            const distance = Math.sqrt(Math.pow(newLeft - currentLeft, 2) + Math.pow(newTop - currentTop, 2));

            // åªæœ‰è¿‡æ¸¡åŠ¨ç”»å¯ç”¨ä¸”ç§»åŠ¨è·ç¦»å¤§äº10åƒç´ æ‰æ’­æ”¾èµ°è·¯åŠ¨ç”»
            if (distance > 10 && capy.classList.contains('enable-transition')) {
                // æ¸…é™¤ä¹‹å‰çš„èµ°è·¯åŠ¨ç”»å®šæ—¶å™¨
                if (walkingTimeout) {
                    clearTimeout(walkingTimeout);
                }

                capy.classList.add('walking');

                // ç§»åŠ¨å®Œæˆåç§»é™¤èµ°è·¯åŠ¨ç”»ï¼ˆ3ç§’åï¼‰
                walkingTimeout = setTimeout(() => {
                    capy.classList.remove('walking');
                    walkingTimeout = null;
                }, 3000);
            }

            capy.style.left = newLeft + 'px';
            capy.style.top = newTop + 'px';

            currentArea = areaKey;
        }

        // æ›´æ–°æ°´è±šæ˜¾ç¤º
        function updateCapy() {
            const capyImg = document.getElementById('capyImg');
            capyImg.src = capyImages[currentSkin];
        }

        // æ˜¾ç¤ºæ°”æ³¡
        function showBubble(text) {
            const bubble = document.getElementById('bubble');
            const capy = document.getElementById('capybara');

            bubble.textContent = text;
            bubble.style.left = (parseFloat(capy.style.left) + 30) + 'px';
            bubble.style.top = (parseFloat(capy.style.top) - 50) + 'px';
            bubble.classList.add('show');

            setTimeout(() => bubble.classList.remove('show'), 3000);
        }

        // æ›´æ–°çŠ¶æ€
        function updateState(newState, detail, progress) {
            const config = STATE_CONFIG[newState] || STATE_CONFIG.idle;

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const indicator = document.getElementById('statusIndicator');
            indicator.style.background = config.color;

            // æ›´æ–°çŠ¶æ€æ–‡å­— - æ˜¾ç¤ºåŸå§‹çŠ¶æ€åå’Œè¯¦æƒ…
            document.getElementById('statusText').textContent =
                `[${config.label}:${newState}] ${detail || ''}`;

            // ç§»åŠ¨æ°´è±šåˆ°å¯¹åº”åŒºåŸŸ
            if (newState !== currentState) {
                moveCapyToArea(config.area);
                currentState = newState;

                // æ˜¾ç¤ºæ°”æ³¡
                const texts = BUBBLE_TEXTS[newState];
                if (texts) {
                    showBubble(texts[Math.floor(Math.random() * texts.length)]);
                }
            }

            // æ›´æ–°è¿›åº¦æ¡
            if (progress > 0) {
                const progressBar = document.getElementById('progressBar');
                const progressFill = document.getElementById('progressFill');
                const capy = document.getElementById('capybara');

                progressBar.style.left = capy.style.left;
                progressBar.style.top = (parseFloat(capy.style.top) + 65) + 'px';
                progressBar.style.width = '60px';
                progressBar.classList.add('show');
                progressFill.style.width = progress + '%';
            } else {
                document.getElementById('progressBar').classList.remove('show');
            }
        }

        // æ›´æ–°ç»Ÿè®¡ï¼ˆè®¡ç®—æ—¶é—´ï¼‰
        function updateStats() {
            const now = Date.now();
            const elapsed = (now - lastUpdate) / 1000 / 60; // åˆ†é’Ÿ
            lastUpdate = now;

            if (currentArea && stats.hasOwnProperty(currentArea)) {
                stats[currentArea] += elapsed;
            }

            updateStatsDisplay();
            saveStats(); // æŒä¹…åŒ–ä¿å­˜
        }

        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤ºï¼ˆä¸è®¡ç®—æ—¶é—´ï¼‰
        function updateStatsDisplay() {
            document.getElementById('stat-desk').textContent = formatTime(stats.desk);
            document.getElementById('stat-library').textContent = formatTime(stats.library);
            document.getElementById('stat-server').textContent = formatTime(stats.server);
            document.getElementById('stat-lounge').textContent = formatTime(stats.lounge);
            document.getElementById('stat-meeting').textContent = formatTime(stats.meeting);

            const total = Object.values(stats).reduce((a, b) => a + b, 0);
            document.getElementById('stat-total').textContent = formatTime(total);
        }

        function formatTime(minutes) {
            if (minutes < 0.1) return '0ç§’';
            if (minutes < 1) return Math.floor(minutes * 60) + 'ç§’';
            if (minutes < 60) return Math.floor(minutes) + 'åˆ†é’Ÿ';
            return Math.floor(minutes / 60) + 'å°æ—¶' + Math.floor(minutes % 60) + 'åˆ†';
        }

        // è½®è¯¢çŠ¶æ€
        let pollingInterval = null;
        let statsInterval = null;

        function startPolling() {
            fetchStatus();
            pollingInterval = setInterval(fetchStatus, 2000);
            statsInterval = setInterval(updateStats, 5000); // æ¯5ç§’æ›´æ–°ç»Ÿè®¡
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        function resumePolling() {
            if (!pollingInterval) {
                pollingInterval = setInterval(fetchStatus, 2000);
            }
        }

        async function fetchStatus() {
            // æ¼”ç¤ºæ¨¡å¼ä¸‹ä¸è·å–çœŸå®çŠ¶æ€
            if (demoMode) return;

            try {
                const response = await fetch('/status');
                const data = await response.json();
                updateState(data.state, data.detail, data.progress || 0);
            } catch (e) {
                console.error('Failed to fetch status:', e);
            }
        }

        // éšæœºæ°”æ³¡
        function startBubbleTimer() {
            setInterval(() => {
                if (Math.random() < 0.3) {
                    const texts = BUBBLE_TEXTS[currentState];
                    if (texts) {
                        showBubble(texts[Math.floor(Math.random() * texts.length)]);
                    }
                }
            }, 8000);
        }

        // ========== æ¼”ç¤ºæ¨¡å¼ ==========
        let demoMode = false;
        let demoInterval = null;
        let demoStateIndex = 0;

        // æ¼”ç¤ºçŠ¶æ€åºåˆ— - æ¨¡æ‹ŸAIå·¥ä½œæµç¨‹
        const DEMO_SEQUENCE = [
            { state: 'idle', detail: 'ç­‰å¾…ä»»åŠ¡ä¸­...', progress: 0 },
            { state: 'responding', detail: 'æ”¶åˆ°ï¼è®©æˆ‘æ¥å¤„ç†...', progress: 5 },
            { state: 'thinking', detail: 'åˆ†æç”¨æˆ·éœ€æ±‚...', progress: 10 },
            { state: 'discussing', detail: 'ç¡®è®¤ä¸€ä¸‹éœ€æ±‚ç»†èŠ‚...', progress: 15 },
            { state: 'researching', detail: 'æŸ¥æ‰¾ç›¸å…³ä»£ç ...', progress: 20 },
            { state: 'reading', detail: 'é˜…è¯» index.html...', progress: 30 },
            { state: 'planning', detail: 'è§„åˆ’å®ç°æ–¹æ¡ˆ...', progress: 35 },
            { state: 'explaining', detail: 'è§£é‡Šä¸€ä¸‹æˆ‘çš„æ€è·¯...', progress: 40 },
            { state: 'writing', detail: 'ç¼–å†™æ–°åŠŸèƒ½ä»£ç ...', progress: 50 },
            { state: 'coding', detail: 'ä¼˜åŒ–ä»£ç ç»“æ„...', progress: 60 },
            { state: 'debugging', detail: 'ä¿®å¤å‘ç°çš„Bug...', progress: 70 },
            { state: 'executing', detail: 'è¿è¡Œæµ‹è¯•è„šæœ¬...', progress: 80 },
            { state: 'testing', detail: 'éªŒè¯åŠŸèƒ½æ­£å¸¸...', progress: 85 },
            { state: 'presenting', detail: 'å±•ç¤ºæˆæœç»™ä½ çœ‹~', progress: 90 },
            { state: 'answering', detail: 'å›ç­”ä½ çš„é—®é¢˜...', progress: 95 },
            { state: 'chatting', detail: 'è¿˜æœ‰å…¶ä»–é—®é¢˜å—ï¼Ÿ', progress: 98 },
            { state: 'idle', detail: 'ä»»åŠ¡å®Œæˆï¼Œä¼‘æ¯ä¸­~', progress: 100 }
        ];

        function toggleDemo() {
            const btn = document.getElementById('demoBtn');
            demoMode = !demoMode;

            if (demoMode) {
                btn.classList.add('active');
                btn.textContent = 'åœæ­¢æ¼”ç¤º';
                stopPolling(); // åœæ­¢åå°è½®è¯¢
                demoStateIndex = 0;
                runDemoStep();
                demoInterval = setInterval(runDemoStep, 5000); // æ¯5ç§’åˆ‡æ¢çŠ¶æ€
            } else {
                btn.classList.remove('active');
                btn.textContent = 'æ¼”ç¤ºæ¨¡å¼';
                if (demoInterval) {
                    clearInterval(demoInterval);
                    demoInterval = null;
                }
                // æ¢å¤æ­£å¸¸è½®è¯¢
                resumePolling();
                fetchStatus();
            }
        }

        function runDemoStep() {
            const step = DEMO_SEQUENCE[demoStateIndex];
            updateState(step.state, step.detail, step.progress);

            demoStateIndex = (demoStateIndex + 1) % DEMO_SEQUENCE.length;
        }

        // ========== ç»Ÿè®¡æ•°æ®æŒä¹…åŒ– ==========
        function saveStats() {
            try {
                localStorage.setItem('capyOfficeStats', JSON.stringify(stats));
                localStorage.setItem('capyOfficeStatsDate', new Date().toDateString());
            } catch (e) {}
        }

        function loadStats() {
            try {
                const savedDate = localStorage.getItem('capyOfficeStatsDate');
                // åªæ¢å¤å½“å¤©çš„ç»Ÿè®¡
                if (savedDate === new Date().toDateString()) {
                    const saved = localStorage.getItem('capyOfficeStats');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        Object.assign(stats, parsed);
                    }
                } else {
                    // æ–°çš„ä¸€å¤©ï¼Œæ¸…ç©ºç»Ÿè®¡
                    localStorage.removeItem('capyOfficeStats');
                }
            } catch (e) {}
        }

        // å¯åŠ¨
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
